const pubadsRequest = "https://securepubads.g.doubleclick.net/gampad/ads?gdfp_req=1&pvsid=1669914883982979&correlator=4304831490083385&output=ldjh&impl=fif&eid=31063898%2C21067496&vrg=2021120601&ptt=17&gdpr_consent=CPPDPB_PPDPB_AGABCENBzCgAP_AAGPAAAQAIDtB9S5eSWMDeHZ9Y7t0cYUX1R5_oeAijgEAE4IBwRKUIIwWEGAyJESIBqACEAYAIgJAIAdkGEAAAAAAQIABAAHIAEAECAAAIAIEGAABAgIACAAIAAAAEAAQgAAUECAgiAAAcBYgQAAAAAAAAAAAAAgEAAAAAAAAAAAAAAAAAAAAACgbRAgAAcABcAEIAOQAfgBkADQAG0ARwAkQBZgC5AHUAO6Ag4CEAERAJ2AT8ApYBdQDAgGZANYAa8A6gB2wD_gIfATEAu0BiwDaADxkAgAJgAjgCOAFLAScAmIBbAC8xEAQAQwA2QClgGsEAAQASBIEgACwAKgAZAA5AB4AIAAZAA8gCIAIoATAAngBVADmAHoAPwAhABDACIAEcAJYATQApQBbgDZAHsAPgAfoBAwCOAEpAKWAawBMQC2AF5gMNAZIEAAgAkDQBgBDADZAKXAWgBaQDWAMYFQCQAmACOAI4AUuAtAC0gJBATEAtgBeY6BiAAsACoAGQAOQAfACCAGIAZAA8AB9AEQARQAmABPACqAF0AL4AYgAzABzAD0AH4AQwAiABHACWAEwAJoAUYApQBYgC3AGEANEAbIA9gB-gEDAIsARwAlMBaAFpALqAXkA6gCQQFsALtAXmAw0BjADJBwAIAEgApCEBUABYAGQAYgBMACqAF8AMQAZgA9ACOAFiAMIAjgBKYC0ALSAdQBIICTgFsALtAcAQAAgCkJQHQAFgAZAA4AB8AGIAPAAiABMACqAF8AMQAZgA2gCGAEQAI4AUYApQBbgDCAGyARyAtAC0gF1AOoAtgBdoC8wHAEgAIApCkCYABYAFQAMgAcgA-AEEAMQAyAB5AEQARQAmABPACkAFUAL4AYgAzABzAD8AIYARAAowBSgCxAFuAMIAaIA2QB-gEWAI4ASkAvICTgFsALtAXmAw0BjADJCgAIAEgApAAAA.YAAAAAAAAAAA&gdpr=1&addtl_consent=1~46.66.1301.70.1843.108.1878.440.3119.1097.196.202.89.2918.149.338.253.1205.2035.415.1415.162.2677.482.505.494.486.981.1456.89.2090&sc=1&sfv=1-0-38&ecs=20211210&iu_parts=59666047%2Ctheguardian.com%2Cstage%2Carticle%2Cng&enc_prev_ius=%2F0%2F1%2F2%2F3%2F4&prev_iu_szs=320x50%7C1x1%7C2x2%7C88x71%7C300x197%7C300x250&fluid=height&fsbs=1&prev_scp=slot-fabric%3Dfabric1%26ad_group%3Dad_opt%26ad_h%3D16%26slot%3Dtop-above-nav%26amznbid%3D2%26amznp%3D2%26hb_format_ozone%3Dbanner%26hb_size_ozone%3D300x250%26hb_pb_ozone%3D0.44%26hb_adid_ozone%3D1466c2515c11d23-0-oz-0%26hb_bidder_ozone%3Dozone%26hb_format_and%3Dbanner%26hb_size_and%3D300x250%26hb_pb_and%3D0.07%26hb_adid_and%3D259c45b8deb52aa%26hb_bidder_and%3Dand%26hb_format_improvedig%3Dbanner%26hb_size_improvedigit%3D300x250%26hb_pb_improvedigital%3D0.06%26hb_adid_improvedigit%3D245e44990a9657d%26hb_bidder_improvedig%3Dimprovedigital%26hb_format_smartadser%3Dbanner%26hb_size_smartadserve%3D300x250%26hb_pb_smartadserver%3D0.05%26hb_adid_smartadserve%3D23ad5bcd1f7b9dc%26hb_bidder_smartadser%3Dsmartadserver%26hb_format_ix%3Dbanner%26hb_size_ix%3D300x250%26hb_pb_ix%3D0.44%26hb_adid_ix%3D22765412561f4ba%26hb_bidder_ix%3Dix%26hb_format_oxd%3Dbanner%26hb_size_oxd%3D300x250%26hb_pb_oxd%3D0.44%26hb_adid_oxd%3D2154b200c00a2eb%26hb_bidder_oxd%3Doxd%26oz_size%3D300x250%26oz_adId%3D1466c2515c11d23-0-oz-0%26oz_pb_r%3D0.44%26oz_pb%3D0.449%26oz_pb_v%3D2.6.0%26oz_imp_id%3D1466c2515c11d23%26oz_bid%3Dtrue%26oz_winner%3Dopenx%26oz_auc_id%3D05ce807c-2cb7-4bd6-98a8-db56cfb964de%26oz_appnexus_pb_r%3D0.05%26oz_appnexus_adId%3D1466c2515c11d23-2-oz-0%26oz_appnexus_adv%3Dskyscanner.net%26oz_appnexus_crid%3D230257260%26oz_appnexus%3Dappnexus%26oz_ozappnexus_sid%3D831%26oz_ozappnexus_pb_r%3D0.12%26oz_ozappnexus_adId%3D1466c2515c11d23-1-oz-0%26oz_ozappnexus_adv%3Daeglive.com%26oz_ozappnexus_crid%3D326118939%26oz_ozappnexus%3Dozappnexus%26oz_openx_pb_r%3D0.44%26oz_openx_adId%3D1466c2515c11d23-0-oz-0%26oz_openx_adv%3Dinternetalerts.org%2Cdeliveroo.co.uk%26oz_openx_crid%3D80142_8613%26oz_openx%3Dopenx%26hb_pid%3D1116400%26hb_format%3Dbanner%26hb_size%3D300x250%26hb_pb%3D0.44%26hb_adid%3D2154b200c00a2eb%26hb_bidder%3Doxd&cust_params=permutive%3D23527%252C24080%252C24083%252C24086%252C24089%252C24091%252C24518%252C24523%252C24538%252C24552%252C24558%252C24561%252C24571%252C24581%252C24583%252C24584%252C24594%252C24599%252C24601%252C24602%252C24603%252C24604%252C24605%252C24607%252C24608%252C24611%252C24612%252C24613%252C24614%252C24615%252C24616%252C24618%252C24619%252C24624%252C24627%252C24632%252C24633%252C24634%252C24639%252C24646%252C24647%252C24650%252C24653%252C24654%252C24655%252C24656%252C24657%252C24658%252C24659%252C24661%252C24682%252C24684%252C24689%252C24691%252C24692%252C24693%252C24694%252C24699%252C24763%252C24775%252C24925%252C24974%252C24983%252C24984%252C24985%252C25031%252C25086%252C25367%252C25466%252C25467%252C25471%252C25472%252C25480%252C26030%252C26130%252C26419%252C26534%252C26748%252C26752%252C26817%252C26822%252C27534%252C27553%252C27564%252C27592%252C27631%252C27638%252C27872%252C28008%252C28268%252C28478%252C28479%252C28985%252C29249%252C29431%252C31044%252C31207%252C31251%252C31470%252C31500%252C31954%252C32322%252C32328%252C32388%252C32484%252C32510%252C32737%252C32738%252C32773%252C33129%252C33379%252C33392%252C34312%252C34372%252C36847%252C37145%252C37316%252C37344%252C37434%252C37673%252C37751%252C37921%252C38185%252C39636%252C39796%252C39994%252C39996%252C40032%252C40123%252C40192%252C40205%252C40271%252C40273%252C40278%252C40852%252C40867%252C40961%252C42134%252C42135%252C42233%252C43270%252C43272%252C43599%252C43850%252C44182%252C46549%252C47026%252C47509%252C47834%252C48018%252C50447%252C52501%252C52698%252C52947%252C53104%252C53220%252C53301%252C53793%252C54438%252C54759%252C54952%252C54994%252C55191%252C55237%252C56521%252C56617%252C56741%252C56792%252C57824%252C59934%252C60110%252C60459%252C60460%252C60722%252C60835%252C61577%252C61623%252C61624%252C61625%252C61826%252C62154%252C62176%252C62177%252C62332%252C62597%252C62605%252C64286%252C64482%252C64816%252C64932%252C65277%252C66587%252C67162%252C67163%252C69195%252C69480%252C70011%252C71154%252C72592%252C73168%252C73177%252C73368%252C74853%252C75241%252C75328%252C75539%252C75590%252C75667%252C76330%252C76453%252C77557%252C77558%252C77560%252C77562%252C77683%252C79116%252C79204%252C79231%252C79492%252C80377%252C81084%252C81511%252C81748%252C81826%252C82087%252C82098%252C82349%252C82402%252C82404%252C82406%252C82407%252C82408%252C82409%252C82429%252C82437%252C82455%252C82457%252C82458%252C82462%252C82463%252C82465%252C82468%252C82984%252C83113%252C83506%252C83587%252C83589%252C83638%252C84889%252C86009%252C86179%252C86180%252C86181%252C87064%252C87475%252C87476%252C88411%252C88612%252C88625%252C88756%252C88861%252C89723%252C90006%252C90073%252C90081%252C90373%252C90779%252C91178%252C91323%252C41547%252C41548%252C41549%252C41550%252C52701%252C52702%252C52703%252C52704%252Crts%26ab%3DSignInGateMainVariant-main-variant-4%26amtgrp%3D2%26bp%3Dmobile%26cc%3DGB%26cmp_interaction%3Dtcloaded%26consent_tcfv2%3Dt%26dcre%3Dt%26fr%3D30plus%26inskin%3Dt%26pv%3Dkx0mvo8xvfiiu24jxxgz%26rdp%3Dna%26rp%3Ddotcom-rendering%26s%3Dstage%26sens%3Df%26si%3Df%26skinsize%3Ds%26urlkw%3Dbest%252Cof%252Cenemies%252Creview%252Cyoung%252Cvic%252Clondon%26ct%3Darticle%26co%3Dmarklawson%26url%3D%252Fstage%252F2021%252Fdec%252F10%252Fbest-of-enemies-review-young-vic-london%26su%3D0%26edition%3Duk%26tn%3Dreviews%26p%3Dng%26k%3Dstage%252Cculture%252Cus-politics%252Cyoung-vic%252Ctheatre%252Cjames-graham%252Cdavid-harewood%252Cgore-vidal%26sh%3Dhttps%253A%252F%252Fwww.theguardian.com%252Fp%252Fkv4af%26pa%3Dt%26adt%3DveryLow%26alc%3DveryLow%26dlm%3DveryLow%26drg%3DveryLow%26hat%3DveryLow%26off%3DveryLow%26vio%3Dlow%26fra%3Dfalse%26ias-kw%3DIAS_1506123_PG%252CIAS_1500903_PG%26inizio%3Dt&cookie=ID%3Dab22396194a2433a%3AT%3D1627559613%3AS%3DALNI_MaGg2QHYrHVVlfGKpbREGAuNiZqvQ&bc=31&abxe=1&lmt=1639155530&dt=1639155530827&dlt=1639155528179&idt=1345&frm=20&biw=436&bih=1666&oid=2&adxs=68&adys=1234&adks=1003596295&ucis=1&ifi=1&u_his=8&u_h=1800&u_w=3200&u_ah=1777&u_aw=3158&u_cd=24&u_sd=2&flash=0&url=https%3A%2F%2Fwww.theguardian.com%2Fstage%2F2021%2Fdec%2F10%2Fbest-of-enemies-review-young-vic-london&ref=https%3A%2F%2Fwww.theguardian.com%2Fstage%2F2021%2Fdec%2F10%2Fbeverley-knight-scolds-theatregoers-rat-arsed-at-london-musical&vis=1&dmc=8&scr_x=0&scr_y=0&psz=416x2998&msz=300x274&ga_vid=942191040.1627559612&ga_sid=1639155531&ga_hid=1497677577&ga_fc=true&fws=0&ohw=0&btvi=0&uach=WyJtYWNPUyIsIjEwLjE1LjciLCJ4ODYiLCIiLCI5NS4wLjQ2MzguNjkiLFtdLG51bGwsbnVsbCwiNjQiXQ..&nvt=2";

const truncateString = (str) =>
    str.length <= 80 ? str : str.substring(0, 76) + '...';

const truncateArray = (arr) =>
    arr.length >= 10 ? arr.slice(0,9).concat("...") : arr

const sortKeysAndTruncateValues = (obj, truncate) =>
    Object.keys(obj).sort((a,b) => a.localeCompare(b)).reduce((result, key) => {
        const value = obj[key];
        if (truncate) {
            result[key] = typeof value === "string"
                        ? truncateString(value)
                        : Array.isArray(value) ? truncateArray(value) : value;
        } else {
            result[key] = value;
        }
        return result;
    }, {});

const getDomain = (request, startPath) =>
    request.substring(0, request.indexOf(startPath)).substring(8);

const getRequestParams = (request) => {
    const requestPathEncoded = request.substring(request.indexOf("?") + 1);
    const requestPathDecoded = decodeURIComponent(requestPathEncoded);
    return requestPathDecoded.split("&").map(decodeURIComponent);    
}

const parseCustParams = (custParamsString) => {
    const custParams = decodeURIComponent(custParamsString);
    console.log(custParams);
    const custParamsItems = custParams.split("&");
    return custParamsItems.reduce((newParams, cpi) => {
        const [key, value] = cpi.split("=");
        if (value.includes(",")) {
            newParams[key] = value.split(",");
        } else {
            newParams[key] = value;
        }
        return newParams;
    }, {});
}

const parseIfDefined = (obj, key, parseFn) => {
    if (obj && obj[key]) {
        obj[key] = parseFn(obj[key]);
    }
    return undefined;
}

const parseYouTubeRequest = (request, truncate) => {
    let requestSummary = {};

    getRequestParams(request).forEach(rp => {
        const equalIndex = rp.indexOf("=");
        if (rp.startsWith("embed_config")) {
            const embedConfig = JSON.parse(rp.substring(equalIndex+1));
            parseIfDefined(
                embedConfig?.adsConfig?.adTagParameters,
                'cust_params',
                (obj) => sortKeysAndTruncateValues(parseCustParams(obj), truncate)
            )
            parseIfDefined(
                embedConfig?.adsConfig,
                'adTagParameters',
                (obj) => sortKeysAndTruncateValues(obj, truncate)
            )
            requestSummary["embed_config"] = sortKeysAndTruncateValues(embedConfig, truncate);
        } else {
            requestSummary[rp.substring(0, equalIndex)] = rp.substring(equalIndex+1);
        }
    });

    requestSummary["domain"] = getDomain(request, "/embed/");
    requestSummary = sortKeysAndTruncateValues(requestSummary, truncate);
    return JSON.stringify(requestSummary, null ,2);
}

const parseGAMRequest = (request, truncate) => {
    let requestSummary = {};

    getRequestParams(request).forEach(rp => {
        const equalIndex = rp.indexOf("=");
        if (rp.startsWith("cust_params")) {
            const equalIndex = rp.indexOf("=");
            const custParamsString = rp.substring(equalIndex+1);
            requestSummary["cust_params"] = sortKeysAndTruncateValues(parseCustParams(custParamsString), truncate);
        } else {
            requestSummary[rp.substring(0, equalIndex)] = rp.substring(equalIndex+1);
        }
    });

    requestSummary["domain"] = getDomain(request, "/gampad/");
    requestSummary = sortKeysAndTruncateValues(requestSummary, truncate);
    return JSON.stringify(requestSummary, null ,2);
}